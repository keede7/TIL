### 데이터를 영구저장하는 방식

### Redis에서 데이터를 영구저장하려면? (운영부분)

`Redis` 는 모든 데이터가 메모리에 저장되어있기 때문에 서버나 `Redis Instance`가 재시작되면 모든데이터가 유실된다. **복제구조를 사용하더라도 데이터 유실에 안전하다고 볼 수 없다**. 코드상 버그가있거나 사람의 실수로 데이터를 날렸다면 바로 복제본에도 적용되므로 이런경우에 데이터를 복원할수없게된다. **따라서 `Redis`를 `Cache` 이외 용도로 쓴다면 적절한 데이터의 백업이 필요하다.**

`Redis`에서는 영구적으로 데이터를 저장하는 방법 2가지를 제공한다.


**AOF** - 데이터를 변경하는 커맨드가 들어오면 그 커맨드를 모두 그대로 저장한다. 

**RDB** - `SnapShot`방식을사용하므로 저장 당시 메모리에 있는 데이터 그대로를 사진찍듯 파일로 저장한다.

- **RDB 예시**

```jsx
key1->apple
```

- **AOF 예시**

```jsx
set key1 a
set key1 apple
set keys b
del key2s 
// 모든 커맨드 기록이 남아있다.
```

`AOF`는 데이터가 추가되기만해도 대부분 `RDB` 파일보다 커진다.
따라서 주기적으로 해당파일을 압축해서 재작성하는 과정을 거쳐야 한다.

실제로 `AOF`파일은 `Redis Protocol`형태로 저장되고, `RDB`는 `Binary` 파일 형태로 저장되므로 우리는 읽을 수없다.

---

1. **자동 / 수동으로 파일을 저장하는 방법**

`RDB`와 `AOF` 파일 모두 커맨드를 이용해 직접 파일을 생성 할 수 있고 원하는 시점에 파일이 자동생성되도록 설정할 수 있다. `RDB`는 시간단위로 파일을 저장할수있으며 `AOF`는 파일크기를 기준으로 압축되는 시점을 지정할 수 있다.

**1) RDB**

- 자동 : `redis.conf` 파일에서 `SAVE` 옵션(시간 기준)
- 수동 : `BGSAVE` 커맨드를 이용해서 `CLI`창에서 수동으로 `RDB`파일 저장
    - `SAVE` 커맨드는 절대 사용하면 안된다.

**2) AOF**

- 자동: `redis.conf` 파일에서 `auto-aof-rewrite-percentage` 옵션(크기 기준)
- 수동 : `BGREWRITEAOF` 커맨드를 이용해 `CLI` 창에서 수동으로 `AOF`파일 재작성

1. **RDB vs AOF 선택 기준** 

백업을 사용할건데 `RDB`와 `AOF`중 어떤 걸 사용해야할지 모르겠다면 다음기준을 따른다.

만약 `Redis`를 `Cache` 로 만 사용한다면 굳이 이 기능을 쓸 필요는 없다. 백업이 필요한데 어느정도 데이터 손실을 감수할 수 있다면 `RDB`만 사용하여도 된다. 대신 `redis.conf`에 `SAVE` 옵션을 적절히 써 야한다.

예로 `SAVE 900 1` 이라고 저장하면 `900`초 동안 한 개 이상의 `Key`가 변경되었을 때 `RDB` 파일을 재작성하라는 의미이다.

만약 장애 상황 직전까지의 모든 데이터가 보장되어야할 경우라면 `AOF`를 사용하면 된다.

이 때 `APPENDFSYNC` 옵션이 기본값인 `EverySecond` 인 경우에는 최대 1초사이의 데이터는 유실될 가능성이있다.

가장 강력한 내구성이 필요하면 `AOF`, `RDB`를 모두 동시에 사용하라고 공식문서에 기재되어있다.
